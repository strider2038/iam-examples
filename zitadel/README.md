# Пример приложения с использованием Zitadel

## Общие сведения

Подробнее о Zitadel <https://zitadel.com/>

Приложение состоит из двух сервисов.

* API Gateway - входная точка в приложение, обеспечивающая аутентификацию с помощью Zitadel.
  * Проверяет сессию пользователя с помощью Zitadel API.
  * Проксирует запросы к бэкенд-приложению подставляя сессионные заголовки в запрос.
    * `X-User-Id` - идентификатор пользователя.
    * `X-Company-Id` - идентификатор компании пользователя.
* App - бизнес-логика приложения. Абстрагирована от системы IAM, имеет две точки интеграции.
  * В запросе получает сессионные заголовки от API Gateway (см. выше).
  * Получает информацию о пользователях через Zitadel API (реализация репозитория `UserRepository`).

## Запуск

1. Запустить docker compose.
2. Настроить Zitadel, см. <https://zitadel.com/docs/self-hosting/deploy/compose>.
3. Добавить приложение в Zitadel, см. <https://zitadel.com/docs/examples/login/go>.
4. Добавить Client ID в файл `.env.local` в переменную окружения `ZITADEL_CLIENT_ID`.

Для настройки клиента Zitadel API на стороне приложения необходимо

1. Создать сервисного пользователя <http://localhost:8080/ui/console/users?type=machine>.
2. Назначить ему роль IAM Owner Viewer <http://localhost:8080/ui/console/instance/members>.
3. Сгенерировать JWT ключ доступа
   1. Сохранить в папке secrets файл с ключом. 
   2. Указать в переменной окружения `ZITADEL_KEY_PATH` путь к нему.

